// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE USER & AUTHENTICATION
// ============================================================================

model User {
  id                  String    @id @default(cuid())
  discordId           String    @unique
  username            String    @unique
  email               String?   @unique
  avatar              String?
  banner              String?
  bio                 String?
  
  // Discord integration
  discordRoles        String[]
  discordGuild        String?
  
  // Credits & Economy
  zellixCredits       Int       @default(0)
  creditsUpdatedAt    DateTime  @default(now()) @updatedAt
  
  // Profile
  status              String?   @default("offline")
  favoriteGame        String?   @default("RUST")
  
  // Relationships
  achievements        Achievement[]
  gameStats           GameStat[]
  events              EventRSVP[]
  tickets             Ticket[]
  credits             CreditTransaction[]
  forum               ForumPost[]
  gallery             GalleryItem[]
  friends             User[]    @relation("Friends")
  friendedBy          User[]    @relation("Friends")
  badges              Badge[]
  leaderboards        LeaderboardEntry[]
  
  // Timestamps
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  lastActiveAt        DateTime  @default(now())
  
  @@index([discordId])
  @@index([username])
  @@index([zellixCredits])
}

// ============================================================================
// ACHIEVEMENTS & BADGES
// ============================================================================

model Achievement {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String
  description String
  icon        String?
  
  // Achievement types
  type        String    // RUST_LORD, HEADSHOT_MACHINE, ROLEPLAY_MASTER, etc.
  category    String    // GAME_STATS, COMMUNITY, EVENT, ECONOMY
  
  progress    Int       @default(0)
  maxProgress Int
  unlocked    Boolean   @default(false)
  unlockedAt  DateTime?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@unique([userId, type])
  @@index([userId])
}

model Badge {
  id          String    @id @default(cuid())
  name        String    @unique
  description String
  icon        String?
  color       String?
  
  users       User[]
  
  createdAt   DateTime  @default(now())
}

// ============================================================================
// GAME STATISTICS
// ============================================================================

model GameStat {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  game          String    // RUST, CS2, GTA5
  platform      String    // STEAM, ROCKSTAR, ETC
  
  // Rust Stats
  rustHours     Int?
  rustKills     Int?
  rustDeaths    Int?
  rustRaids     Int?
  
  // CS2 Stats
  cs2Matches    Int?
  cs2Wins       Int?
  cs2Headshots  Int?
  cs2KD         Float?
  cs2Rank       String?
  
  // GTA5 RP Stats
  gtaRpHours    Int?
  gtaRpJobs     Int?
  gtaRpFaction  String?
  gtaRpLevel    Int?
  
  lastUpdated   DateTime  @default(now()) @updatedAt
  externalId    String?
  
  createdAt     DateTime  @default(now())
  
  @@unique([userId, game, platform])
  @@index([userId])
  @@index([game])
}

// ============================================================================
// EVENTS & CALENDAR
// ============================================================================

model Event {
  id            String      @id @default(cuid())
  title         String
  description   String      @db.Text
  image         String?
  
  game          String      // RUST, CS2, GTA5, SOCIAL
  eventType     String      // TOURNAMENT, RAID, MEETING, SOCIAL
  
  startTime     DateTime
  endTime       DateTime
  
  location      String?
  discordVoice  String?
  
  maxParticipants Int?
  
  // Permissions
  isPublic      Boolean     @default(true)
  requiresApproval Boolean   @default(false)
  
  participants  EventRSVP[]
  discordEventId String?
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([startTime])
  @@index([game])
}

model EventRSVP {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  eventId   String
  event     Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  status    String    @default("PENDING") // PENDING, CONFIRMED, ATTENDED, CANCELLED
  joinedAt  DateTime  @default(now())
  
  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
  @@index([status])
}

// ============================================================================
// CREDITS & ECONOMY
// ============================================================================

model CreditTransaction {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  amount      Int
  type        String    // EARN, SPEND
  source      String    // VOICE_CHAT, EVENT, FORUM, DAILY_LOGIN, etc.
  reason      String?
  
  previousBalance Int
  newBalance  Int
  
  metadata    Json?     // Additional data like eventId, postId, etc.
  
  createdAt   DateTime  @default(now())
  
  @@index([userId])
  @@index([createdAt])
}

model LeaderboardEntry {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  category    String    // CREDITS, VOICE_HOURS, EVENTS, POSTS, GAMES
  game        String?   // For game-specific leaderboards
  
  rank        Int
  score       Int
  
  period      String    @default("WEEKLY") // WEEKLY, MONTHLY, ALLTIME
  week        Int?
  month       Int?
  year        Int?
  
  updatedAt   DateTime  @updatedAt
  
  @@unique([userId, category, game, period, week, month, year])
  @@index([category])
  @@index([rank])
}

// ============================================================================
// SUPPORT TICKETS
// ============================================================================

model Ticket {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title       String
  description String    @db.Text
  category    String    // BUG, FEATURE, SUPPORT, APPEAL
  priority    String    @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL
  
  status      String    @default("OPEN") // OPEN, IN_PROGRESS, CLOSED, RESOLVED
  
  attachments String[]
  
  responses   TicketResponse[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  closedAt    DateTime?
  
  @@index([userId])
  @@index([status])
}

model TicketResponse {
  id        String    @id @default(cuid())
  ticketId  String
  ticket    Ticket    @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  message   String    @db.Text
  isAdmin   Boolean   @default(false)
  
  createdAt DateTime  @default(now())
  
  @@index([ticketId])
}

// ============================================================================
// FORUM
// ============================================================================

model ForumPost {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title       String
  content     String    @db.Text
  category    String    // GENERAL, RUST, CS2, GTA5, EVENTS, BUG_REPORTS
  
  isPinned    Boolean   @default(false)
  isLocked    Boolean   @default(false)
  views       Int       @default(0)
  
  replies     ForumReply[]
  likes       Int       @default(0)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([userId])
  @@index([category])
  @@index([createdAt])
}

model ForumReply {
  id        String    @id @default(cuid())
  postId    String
  post      ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  userId    String
  content   String    @db.Text
  
  likes     Int       @default(0)
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  @@index([postId])
}

// ============================================================================
// WIKI / KNOWLEDGE BASE
// ============================================================================

model WikiPage {
  id          String    @id @default(cuid())
  slug        String    @unique
  title       String
  description String?
  
  content     String    @db.Text
  category    String    // GUIDES, RUST, CS2, GTA5, COMMUNITY_RULES
  
  views       Int       @default(0)
  version     Int       @default(1)
  
  isPublished Boolean   @default(true)
  
  history     WikiHistory[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([slug])
  @@index([category])
}

model WikiHistory {
  id        String    @id @default(cuid())
  pageId    String
  page      WikiPage  @relation(fields: [pageId], references: [id], onDelete: Cascade)
  
  version   Int
  content   String    @db.Text
  
  createdAt DateTime  @default(now())
}

// ============================================================================
// MEDIA GALLERY
// ============================================================================

model GalleryItem {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title       String
  description String?
  
  type        String    // IMAGE, VIDEO, CLIP
  url         String
  thumbnail   String?
  
  game        String?   // RUST, CS2, GTA5
  
  isPublished Boolean   @default(true)
  isFeatured  Boolean   @default(false)
  
  likes       Int       @default(0)
  views       Int       @default(0)
  
  comments    GalleryComment[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([userId])
  @@index([game])
  @@index([isPublished])
}

model GalleryComment {
  id        String    @id @default(cuid())
  itemId    String
  item      GalleryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  content   String    @db.Text
  
  createdAt DateTime  @default(now())
}

// ============================================================================
// MINI-GAMES & SCORES
// ============================================================================

model GameScore {
  id          String    @id @default(cuid())
  userId      String
  gameId      String    // rust_raid_simulator, cs2_aim_trainer, gta_chase
  
  score       Int
  level       Int       @default(1)
  duration    Int       // seconds
  
  metadata    Json?     // Game-specific data
  
  createdAt   DateTime  @default(now())
  
  @@index([userId])
  @@index([gameId])
  @@index([score])
}

// ============================================================================
// ADMIN & SYSTEM
// ============================================================================

model AdminLog {
  id        String    @id @default(cuid())
  action    String
  target    String?
  details   Json?
  
  createdAt DateTime  @default(now())
  
  @@index([action])
  @@index([createdAt])
}

model SystemConfig {
  id          String    @id @default(cuid())
  key         String    @unique
  value       String    @db.Text
  description String?
  
  updatedAt   DateTime  @updatedAt
}

// ============================================================================
// DISCORD BOT SETTINGS
// ============================================================================

model DiscordSettings {
  id          String    @id @default(cuid())
  guildId     String    @unique
  
  // Channels
  logsChannelId         String?
  creditsChannelId      String?
  eventsChannelId       String?
  announcementsChannelId String?
  
  // Roles
  verifiedRoleId        String?
  boosterRoleId         String?
  
  // Settings
  autoAssignRoles       Boolean   @default(true)
  postEventReminders    Boolean   @default(true)
  creditNotifications   Boolean   @default(true)
  
  updatedAt             DateTime  @updatedAt
}

// ============================================================================
// CHAT & INVENTORY
// ============================================================================

model ChatMessage {
  id        String   @id @default(cuid())
  channelId String?
  userId    String
  content   String   @db.Text
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([channelId])
  @@index([userId])
}

model InventoryItem {
  id        String   @id @default(cuid())
  userId    String
  itemId    String
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([itemId])
}
